generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  GESTOR
  INSTITUICAO
  AGRICULTOR
  EMPRESA
}

enum RequestStatus {
  DRAFT
  SUBMITTED
  NEEDS_REVIEW
  VALIDATED
  ORCHESTRATING
  PROPOSALS_SENT
  FULFILLING
  DELIVERED
  CLOSED
  CANCELLED
}

enum OfferStatus {
  DRAFTED
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  APPROVED
  REJECTED
}

enum ProgramType {
  PNAE
  PAA
  OUTROS
}

enum CAFStatus {
  ATIVO
  PENDENTE
  INATIVO
}

enum ConversationStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

enum ImpactCreditStatus {
  DISPONIVEL
  VENDIDO
  RESERVADO
}

enum SenderRole {
  FARMER
  ASSISTANT
  MANAGER
  SYSTEM
}

enum AgentType {
  NEGOTIATOR
  VALIDATOR
}

enum EvidenceScope {
  REQUEST_PROOF
  REQUEST_DOCUMENT
  DELIVERY_PROOF
  DELIVERY_DOCUMENT
  INSTITUTION_PHOTO
  FARMER_DOCUMENT
}

enum EvidenceExtractionStatus {
  PENDING
  DONE
  FAILED
}

model Municipality {
  id        String  @id @default(cuid())
  name      String
  state     String
  centerLat Float?
  centerLng Float?

  users         User[]
  farmers       Farmer[]
  institutions  Institution[]
  requests      Request[]
  credits       ImpactCredit[]
  agentConfigs  AgentConfig[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String   @id @default(cuid())
  email          String?  @unique
  passwordHash   String?
  role           UserRole
  displayName    String
  avatarUrl      String?
  avatarPublicId String?
  municipalityId String?
  municipality   Municipality? @relation(fields: [municipalityId], references: [id])

  farmer      Farmer?
  institution Institution?
  company     Company?
  auditLogs   AuditLog[]
  agentRuns   AgentRun[]
  uploadedEvidence Evidence[] @relation("EvidenceUploadedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Farmer {
  id             String    @id @default(cuid())
  userId         String?   @unique
  user           User?     @relation(fields: [userId], references: [id])
  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id])

  name      String
  products  String[]
  capacity  String?
  cafStatus CAFStatus
  lat       Float?
  lng       Float?
  address   String?
  phone     String?

  offers       Offer[]
  agentConfigs AgentConfig[]
  credits      ImpactCredit[]
  conversations Conversation[]
  evidence      Evidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Institution {
  id             String   @id @default(cuid())
  userId         String?  @unique
  user           User?    @relation(fields: [userId], references: [id])
  municipalityId String
  municipality   Municipality @relation(fields: [municipalityId], references: [id])

  name    String
  type    String
  lat     Float?
  lng     Float?
  address String?
  phone   String?

  requests Request[]
  credits  ImpactCredit[]
  evidence Evidence[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Request {
  id            String       @id @default(cuid())
  municipalityId String
  municipality  Municipality @relation(fields: [municipalityId], references: [id])

  institutionId String
  institution   Institution @relation(fields: [institutionId], references: [id])

  program       ProgramType
  status        RequestStatus @default(DRAFT)
  urgency       Int
  needByDate    DateTime
  title         String?
  address       String?
  lat           Float?
  lng           Float?
  justification String?

  items         RequestItem[]
  offers        Offer[]
  agentRuns     AgentRun[]
  evidence      Evidence[]
  delivery      DeliveryConfirmation?
  impactCredits ImpactCredit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RequestItem {
  id          String  @id @default(cuid())
  requestId   String
  request     Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  productName String
  quantity    Float
  unit        String
}

model Offer {
  id           String     @id @default(cuid())
  requestId    String
  request      Request    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  farmerId     String
  farmer       Farmer     @relation(fields: [farmerId], references: [id])
  status       OfferStatus @default(DRAFTED)

  proposedValue Float?
  marketValue   Float?
  distanceKm    Float?

  // snapshot do que foi proposto (para a UI)
  items        OfferItem[]
  conversation Conversation?
  evidence     Evidence[]
  credits      ImpactCredit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OfferItem {
  id          String @id @default(cuid())
  offerId     String
  offer       Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)
  productName String
  quantity    Float
  unit        String
}

model AgentConfig {
  id              String   @id @default(cuid())
  municipalityId  String
  municipality    Municipality @relation(fields: [municipalityId], references: [id])

  // opcional: config específica por agricultor
  farmerId        String?
  farmer          Farmer? @relation(fields: [farmerId], references: [id])

  farmerName      String?
  type            AgentType @default(NEGOTIATOR)
  personality     String
  objectives      String[]
  offerCalculation String
  fixedDiscounts  Json?
  customFormula   String?
  instructions    String?
  // Para agentes validadores (regras/checklists/config por escopo). Mantemos JSON para evoluir rápido sem travar schema.
  validatorConfig Json?
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([municipalityId])
  @@index([municipalityId, type])

  conversations Conversation[]
}

model AgentRun {
  id            String @id @default(cuid())
  requestId     String
  request       Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  startedByUserId String?
  startedByUser   User? @relation(fields: [startedByUserId], references: [id])
  status        String
  explainability Json?
  createdOffers  String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Conversation {
  id          String @id @default(cuid())
  offerId     String @unique
  offer       Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)

  farmerId    String
  farmer      Farmer @relation(fields: [farmerId], references: [id])
  agentConfigId String?
  agentConfig   AgentConfig? @relation(fields: [agentConfigId], references: [id])

  status       ConversationStatus @default(ACTIVE)
  unreadFarmer Int @default(0)
  unreadManager Int @default(0)

  lastMessageAt DateTime?

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Message {
  id             String @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         SenderRole
  content        String
  metadata       Json?

  createdAt DateTime @default(now())
}

model Evidence {
  id         String @id @default(cuid())
  scope      EvidenceScope @default(REQUEST_PROOF)

  requestId  String?
  request    Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)

  offerId    String?
  offer      Offer? @relation(fields: [offerId], references: [id], onDelete: Cascade)

  institutionId String?
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: Cascade)

  farmerId   String?
  farmer     Farmer? @relation(fields: [farmerId], references: [id], onDelete: Cascade)

  url        String
  publicId   String?
  resourceType String? // image | raw
  fileType   String?   // mime type
  originalName String?
  sizeBytes  Int?
  kind       String?

  extractedText     String?
  extractionStatus  EvidenceExtractionStatus @default(PENDING)

  uploadedByUserId String?
  uploadedByUser   User? @relation("EvidenceUploadedBy", fields: [uploadedByUserId], references: [id])
  uploadedByRole   UserRole?
  createdAt  DateTime @default(now())

  @@index([scope])
  @@index([requestId])
  @@index([offerId])
}

model DeliveryConfirmation {
  id         String @id @default(cuid())
  requestId  String @unique
  request    Request @relation(fields: [requestId], references: [id], onDelete: Cascade)
  confirmedAt DateTime @default(now())
  notes      String?
}

model ImpactCredit {
  id              String @id @default(cuid())
  municipalityId  String
  municipality    Municipality @relation(fields: [municipalityId], references: [id])

  farmerId        String
  farmer          Farmer @relation(fields: [farmerId], references: [id])
  offerId         String
  offer           Offer @relation(fields: [offerId], references: [id])
  requestId       String
  request         Request @relation(fields: [requestId], references: [id])
  institutionId   String
  institution     Institution @relation(fields: [institutionId], references: [id])

  monetaryValue   Float
  impactCredits   Int
  unitType        String
  status          ImpactCreditStatus @default(DISPONIVEL)
  program         ProgramType
  backing         Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchasedByCompanyId String?
  purchasedByCompany   Company? @relation(fields: [purchasedByCompanyId], references: [id])
  purchasedAt DateTime?

  listedAt DateTime?
}

model Company {
  id        String @id @default(cuid())
  userId    String? @unique
  user      User? @relation(fields: [userId], references: [id])
  name      String
  purchases ImpactCredit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id          String @id @default(cuid())
  actorUserId String?
  actorUser   User? @relation(fields: [actorUserId], references: [id])
  action      String
  entityType  String
  entityId    String
  details     Json?

  createdAt DateTime @default(now())
}


